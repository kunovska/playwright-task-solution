name: Playwright E2E (Docker)

on:
  workflow_dispatch:
    inputs:
      test_env:
        description: 'Environment'
        type: choice
        required: true
        default: qa
        options:
          - qa
          - staging

      test_type:
        description: 'Test type'
        type: choice
        required: true
        default: regression
        options:
          - smoke
          - regression

      parallelization:
        description: 'Parallelization mode'
        type: choice
        required: true
        default: none
        options:
          - none
          - spec-files
          - browsers

      browser:
        description: 'Browser (used when parallelization = none or spec-files)'
        type: choice
        required: true
        default: chromium
        options:
          - chromium
          - firefox
          - webkit

      headed:
        description: 'Headed mode (debug only)'
        type: boolean
        required: true
        default: false

env:
  TEST_ENV: ${{ inputs.test_env }}
  BASE_URL_QA: ${{ vars.BASE_URL_QA || 'https://www.saucedemo.com' }}
  BASE_URL_STAGING: ${{ vars.BASE_URL_STAGING || 'https://www.saucedemo.com' }}
  SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD || 'secret_sauce' }}
  HEADLESS: ${{ inputs.headed && 'false' || 'true' }}
  CI: true

# -------------------------------
# MODE 1 — NO PARALLELIZATION
# -------------------------------
jobs:
  single:
    name: 'Docker | Single | ${{ inputs.test_env }} | ${{ inputs.test_type }} | ${{ inputs.browser }}'
    if: ${{ inputs.parallelization == 'none' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t saucedemo-tests .

      - name: Run Playwright in Docker
        shell: bash
        run: |
          set -e

          # Select grep tag
          if [ "${{ inputs.test_type }}" = "smoke" ]; then
            GREP='--grep @smoke'
          else
            GREP='--grep @regression'
          fi

          # Compute BASE_URL from TEST_ENV
          if [ "${{ inputs.test_env }}" = "staging" ]; then
            BASE_URL="${BASE_URL_STAGING}"
          else
            BASE_URL="${BASE_URL_QA}"
          fi

          docker run --rm \
            -e CI=true \
            -e HEADLESS="${HEADLESS}" \
            -e TEST_ENV="${TEST_ENV}" \
            -e SAUCE_PASSWORD="${SAUCE_PASSWORD}" \
            -e BASE_URL="${BASE_URL}" \
            -e BASE_URL_QA="${BASE_URL_QA}" \
            -e BASE_URL_STAGING="${BASE_URL_STAGING}" \
            -v "${PWD}/playwright-report:/app/playwright-report" \
            -v "${PWD}/test-results:/app/test-results" \
            saucedemo-tests --project=${{ inputs.browser }} $GREP

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-docker-${{ inputs.test_env }}-${{ inputs.test_type }}-${{ inputs.browser }}-single
          path: |
            playwright-report
            test-results
          retention-days: 14

  # --------------------------------------
  # MODE 2 — PARALLEL BY SPEC FILE (SUITE)
  # --------------------------------------
  spec-files:
    name: 'Docker | Spec parallel | ${{ inputs.test_env }} | ${{ inputs.test_type }} | ${{ inputs.browser }} | ${{ matrix.spec_name }}'
    if: ${{ inputs.parallelization == 'spec-files' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        spec_path:
          - tests/auth.spec.ts
          - tests/products.spec.ts
          - tests/cart-all-products.spec.ts
          - tests/checkout.spec.ts
          - tests/burger-menu.spec.ts
        include:
          - spec_path: tests/auth.spec.ts
            spec_name: auth
          - spec_path: tests/products.spec.ts
            spec_name: products
          - spec_path: tests/cart-all-products.spec.ts
            spec_name: cart
          - spec_path: tests/checkout.spec.ts
            spec_name: checkout
          - spec_path: tests/burger-menu.spec.ts
            spec_name: burger-menu

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t saucedemo-tests .

      - name: Run Playwright in Docker (single spec)
        shell: bash
        run: |
          set -e

          if [ "${{ inputs.test_type }}" = "smoke" ]; then
            GREP='--grep @smoke'
          else
            GREP='--grep @regression'
          fi

          if [ "${{ inputs.test_env }}" = "staging" ]; then
            BASE_URL="${BASE_URL_STAGING}"
          else
            BASE_URL="${BASE_URL_QA}"
          fi

          docker run --rm \
            -e CI=true \
            -e HEADLESS="${HEADLESS}" \
            -e TEST_ENV="${TEST_ENV}" \
            -e SAUCE_PASSWORD="${SAUCE_PASSWORD}" \
            -e BASE_URL="${BASE_URL}" \
            -e BASE_URL_QA="${BASE_URL_QA}" \
            -e BASE_URL_STAGING="${BASE_URL_STAGING}" \
            -v "${PWD}/playwright-report:/app/playwright-report" \
            -v "${PWD}/test-results:/app/test-results" \
            saucedemo-tests --project=${{ inputs.browser }} $GREP ${{ matrix.spec_path }}

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-docker-${{ inputs.test_env }}-${{ inputs.test_type }}-${{ inputs.browser }}-${{ matrix.spec_name }}
          path: |
            playwright-report
            test-results
          retention-days: 14

  # --------------------------------------
  # MODE 3 — PARALLEL BY BROWSER
  # --------------------------------------
  browsers:
    name: 'Docker | Browser parallel | ${{ inputs.test_env }} | ${{ inputs.test_type }} | ${{ matrix.browser }}'
    if: ${{ inputs.parallelization == 'browsers' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t saucedemo-tests .

      - name: Run Playwright in Docker (all tests)
        shell: bash
        run: |
          set -e

          if [ "${{ inputs.test_type }}" = "smoke" ]; then
            GREP='--grep @smoke'
          else
            GREP='--grep @regression'
          fi

          if [ "${{ inputs.test_env }}" = "staging" ]; then
            BASE_URL="${BASE_URL_STAGING}"
          else
            BASE_URL="${BASE_URL_QA}"
          fi

          docker run --rm \
            -e CI=true \
            -e HEADLESS="${HEADLESS}" \
            -e TEST_ENV="${TEST_ENV}" \
            -e SAUCE_PASSWORD="${SAUCE_PASSWORD}" \
            -e BASE_URL="${BASE_URL}" \
            -e BASE_URL_QA="${BASE_URL_QA}" \
            -e BASE_URL_STAGING="${BASE_URL_STAGING}" \
            -v "${PWD}/playwright-report:/app/playwright-report" \
            -v "${PWD}/test-results:/app/test-results" \
            saucedemo-tests --project=${{ matrix.browser }} $GREP

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-docker-${{ inputs.test_env }}-${{ inputs.test_type }}-${{ matrix.browser }}
          path: |
            playwright-report
            test-results
          retention-days: 14
