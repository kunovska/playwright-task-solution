name: Playwright E2E CI

on:
  workflow_dispatch:
    inputs:
      test_env:
        description: "Environment"
        type: choice
        required: true
        default: qa
        options:
          - qa
          - staging

      test_type:
        description: "Test type"
        type: choice
        required: true
        default: regression
        options:
          - smoke
          - regression

      parallelization:
        description: "Parallelization mode"
        type: choice
        required: true
        default: none
        options:
          - none
          - spec-files
          - browsers

      browser:
        description: "Browser (used when parallelization = none or spec-files)"
        type: choice
        required: true
        default: chromium
        options:
          - chromium
          - firefox
          - webkit

      headed:
        description: "Headed mode (debug only)"
        type: boolean
        required: true
        default: false

env:
  TEST_ENV: ${{ inputs.test_env }}

  BASE_URL_QA: ${{ vars.BASE_URL_QA }}
  BASE_URL_STAGING: ${{ vars.BASE_URL_STAGING }}

  BASE_URL: ${{ inputs.test_env == 'qa' && vars.BASE_URL_QA || vars.BASE_URL_STAGING }}

  SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}
  HEADLESS: ${{ inputs.headed && 'false' || 'true' }}
  CI: true

# --------------------------------------
# Helper: Discover spec files dynamically
# (Only runs when parallelization == spec-files)
# --------------------------------------
jobs:
  discover-specs:
    name: Discover spec files
    if: ${{ inputs.parallelization == 'spec-files' }}
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        name: Build matrix from tests/*.spec.ts
        shell: bash
        run: |
          set -euo pipefail

          if ! ls tests/*.spec.ts >/dev/null 2>&1; then
            echo "No spec files found at tests/*.spec.ts"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Produce: [{"spec_path":"tests/foo.spec.ts","spec_name":"foo"}, ...]
          matrix_json=$(ls tests/*.spec.ts | sort | jq -R -s -c '
            split("\n")[:-1]
            | map({
                spec_path: .,
                spec_name: (split("/")[-1] | sub("\\.spec\\.ts$"; ""))
              })
          ')

          echo "matrix=$matrix_json" >> "$GITHUB_OUTPUT"

  # -------------------------------
  # MODE 1 — NO PARALLELIZATION
  # -------------------------------
  single:
    name: "Single run | ${{ inputs.test_env }} | ${{ inputs.test_type }} | ${{ inputs.browser }}"
    if: ${{ inputs.parallelization == 'none' }}
    runs-on: ubuntu-latest

    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Validate required env (no hardcoded fallbacks)
        shell: bash
        run: |
          set -euo pipefail
          : "${BASE_URL_QA:?Missing repo variable BASE_URL_QA}"
          : "${BASE_URL_STAGING:?Missing repo variable BASE_URL_STAGING}"
          : "${BASE_URL:?BASE_URL resolved empty (check test_env and repo vars)}"
          : "${SAUCE_PASSWORD:?Missing repo secret SAUCE_PASSWORD}"

      - name: Run Playwright
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.test_type }}" = "smoke" ]; then
            GREP_ARGS=(--grep '@smoke')
          else
            GREP_ARGS=(--grep '@regression')
          fi

          npx playwright test \
            --project="${{ inputs.browser }}" \
            "${GREP_ARGS[@]}"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ inputs.test_env }}-${{ inputs.test_type }}-${{ inputs.browser }}-single
          path: |
            playwright-report
            test-results
          retention-days: 14

  # --------------------------------------
  # MODE 2 — PARALLEL BY SPEC FILE (AUTO)
  # --------------------------------------
  spec-files:
    name: "Spec parallel | ${{ inputs.test_env }} | ${{ inputs.test_type }} | ${{ inputs.browser }} | ${{ matrix.spec_name }}"
    if: ${{ inputs.parallelization == 'spec-files' }}
    needs: discover-specs
    runs-on: ubuntu-latest

    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover-specs.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Validate required env
        shell: bash
        run: |
          set -euo pipefail
          : "${BASE_URL_QA:?Missing repo variable BASE_URL_QA}"
          : "${BASE_URL_STAGING:?Missing repo variable BASE_URL_STAGING}"
          : "${BASE_URL:?BASE_URL resolved empty (check test_env and repo vars)}"
          : "${SAUCE_PASSWORD:?Missing repo secret SAUCE_PASSWORD}"

      - name: Run Playwright (single spec)
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.test_type }}" = "smoke" ]; then
            GREP_ARGS=(--grep '@smoke')
          else
            GREP_ARGS=(--grep '@regression')
          fi

          npx playwright test \
            --project="${{ inputs.browser }}" \
            "${GREP_ARGS[@]}" \
            "${{ matrix.spec_path }}"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ inputs.test_env }}-${{ inputs.test_type }}-${{ inputs.browser }}-${{ matrix.spec_name }}
          path: |
            playwright-report
            test-results
          retention-days: 14

  # --------------------------------------
  # MODE 3 — PARALLEL BY BROWSER
  # --------------------------------------
  browsers:
    name: "Browser parallel | ${{ inputs.test_env }} | ${{ inputs.test_type }} | ${{ matrix.browser }}"
    if: ${{ inputs.parallelization == 'browsers' }}
    runs-on: ubuntu-latest

    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Validate required env 
        shell: bash
        run: |
          set -euo pipefail
          : "${BASE_URL_QA:?Missing repo variable BASE_URL_QA}"
          : "${BASE_URL_STAGING:?Missing repo variable BASE_URL_STAGING}"
          : "${BASE_URL:?BASE_URL resolved empty (check test_env and repo vars)}"
          : "${SAUCE_PASSWORD:?Missing repo secret SAUCE_PASSWORD}"

      - name: Run Playwright (all tests)
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.test_type }}" = "smoke" ]; then
            GREP_ARGS=(--grep '@smoke')
          else
            GREP_ARGS=(--grep '@regression')
          fi

          npx playwright test \
            --project="${{ matrix.browser }}" \
            "${GREP_ARGS[@]}"

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ inputs.test_env }}-${{ inputs.test_type }}-${{ matrix.browser }}
          path: |
            playwright-report
            test-results
          retention-days: 14
